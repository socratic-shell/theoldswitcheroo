<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0;
      padding: 0;
      width: 75px;
      height: 100vh;
      background: #2d2d30;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      font-family: system-ui;
    }

    .sessions-container {
      flex: 1;
      padding: 30px 10px 10px 10px; /* Top padding for traffic light buttons */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .session-box {
      width: 55px;
      height: 40px;
      background: #007acc;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
    }

    .session-box.active {
      background: #40a6ff;
    }

    .bottom-toolbar {
      padding: 10px;
      border-top: 1px solid #3e3e42;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toolbar-button {
      width: 55px;
      height: 40px;
      background: #3c3c3c;
      border: none;
      border-radius: 4px;
      color: #cccccc;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .toolbar-button:hover {
      background: #464647;
    }

    .add-button {
      background: #007acc;
    }

    .add-button:hover {
      background: #40a6ff;
    }

    /* Custom scrollbar */
    .sessions-container::-webkit-scrollbar {
      width: 4px;
    }

    .sessions-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .sessions-container::-webkit-scrollbar-thumb {
      background: #464647;
      border-radius: 2px;
    }

    /* Context menu */
    .context-menu {
      position: fixed;
      background: #3c3c3c;
      border: 1px solid #464647;
      border-radius: 4px;
      padding: 4px 0;
      z-index: 1000;
      display: none;
      min-width: 55px;
      width: 55px;
    }

    .context-menu-item {
      padding: 6px 8px;
      color: #cccccc;
      cursor: pointer;
      font-size: 11px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .context-menu-item:hover {
      background: #464647;
    }

    .context-menu-item.danger {
      color: #f48771;
    }

    .context-menu-item.danger:hover {
      background: #5a2d2d;
    }
  </style>
</head>

<body>
  <div class="sessions-container" id="sessions-container">
    <!-- Sessions will be populated dynamically -->
  </div>
  
  <div class="bottom-toolbar">
    <button class="toolbar-button" id="settings-button">âš™</button>
    <button class="toolbar-button add-button" id="add-button">+</button>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    
    // Handle session updates from main process
    ipcRenderer.on('update-sessions', (event, data) => {
      updateSessionsUI(data.sessions, data.activeSessionId);
    });
    
    // Update the sessions UI
    function updateSessionsUI(sessions, activeSessionId) {
      const container = document.getElementById('sessions-container');
      container.innerHTML = '';
      
      sessions.forEach(session => {
        const sessionBox = document.createElement('div');
        sessionBox.className = `session-box ${session.active ? 'active' : ''}`;
        sessionBox.textContent = session.id;
        sessionBox.dataset.sessionId = session.id;
        
        // Add click handler for session switching
        sessionBox.addEventListener('click', () => switchToSession(session.id));
        
        // Add right-click handler for meta-view
        sessionBox.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showMetaView(session.id);
        });
        
        container.appendChild(sessionBox);
      });
    }

    let currentContextSessionId = null;

    // Show context menu
    function showContextMenu(x, y, sessionId) {
      currentContextSessionId = sessionId;
      const contextMenu = document.getElementById('context-menu');
      contextMenu.style.display = 'block';
      
      // Position menu centered horizontally, below the click point
      contextMenu.style.left = '10px'; // Centered in 75px sidebar (with some margin)
      contextMenu.style.top = (y + 10) + 'px'; // Slightly below the click
    }

    // Hide context menu
    function hideContextMenu() {
      document.getElementById('context-menu').style.display = 'none';
      currentContextSessionId = null;
    }

    // Hide context menu when clicking elsewhere
    document.addEventListener('click', hideContextMenu);

    // Handle kill session
    document.getElementById('kill-session').addEventListener('click', async () => {
      if (currentContextSessionId) {
        try {
          const result = await ipcRenderer.invoke('kill-session', currentContextSessionId);
          if (!result.success) {
            alert(`Failed to kill session: ${result.error}`);
          }
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      }
      hideContextMenu();
    });

    // Handle kill others
    document.getElementById('kill-others').addEventListener('click', async () => {
      if (currentContextSessionId) {
        try {
          const result = await ipcRenderer.invoke('kill-others', currentContextSessionId);
          if (result.success) {
            console.log(`Killed ${result.killedCount} other sessions, kept session ${result.keptSessionId}`);
          } else {
            alert(`Failed to kill other sessions: ${result.error}`);
          }
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      }
      hideContextMenu();
    });
    
    // Show meta-view for session
    async function showMetaView(sessionId) {
      try {
        const result = await ipcRenderer.invoke('show-meta-view', sessionId);
        if (!result.success) {
          alert(`Failed to show meta-view: ${result.error}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }
    
    // Handle + button clicks
    document.getElementById('add-button').addEventListener('click', async () => {
      console.log('+ button clicked in sidebar');
      
      // Disable button during creation
      const addButton = document.getElementById('add-button');
      addButton.disabled = true;
      addButton.textContent = '...';
      
      try {
        const result = await ipcRenderer.invoke('create-session');
        console.log('IPC result:', result);
        
        if (result.success) {
          // Add new session box to UI
          addSessionBox(result.session.id);
          console.log(`Added session ${result.session.id} to UI`);
        } else {
          console.error('Session creation failed:', result.error);
          alert(`Failed to create session: ${result.error}`);
        }
      } catch (error) {
        console.error('IPC error:', error);
        alert(`Error: ${error.message}`);
      } finally {
        // Re-enable button
        addButton.disabled = false;
        addButton.textContent = '+';
      }
    });
    
    // Function to add a new session box
    function addSessionBox(sessionId) {
      const sessionsContainer = document.querySelector('.sessions-container');
      const newSessionBox = document.createElement('div');
      newSessionBox.className = 'session-box';
      newSessionBox.textContent = sessionId;
      newSessionBox.dataset.sessionId = sessionId;
      
      // Add click handler for session switching
      newSessionBox.addEventListener('click', () => switchToSession(sessionId));
      
      sessionsContainer.appendChild(newSessionBox);
    }
    
    // Function to switch sessions
    async function switchToSession(sessionId) {
      console.log(`Switching to session ${sessionId}`);
      
      try {
        const result = await ipcRenderer.invoke('switch-session', sessionId);
        
        if (result.success) {
          // Update UI to show active session
          document.querySelectorAll('.session-box').forEach(box => {
            box.classList.remove('active');
          });
          
          const activeBox = document.querySelector(`[data-session-id="${sessionId}"]`);
          if (activeBox) {
            activeBox.classList.add('active');
          }
          
          console.log(`Switched to session ${sessionId}`);
        } else {
          console.error('Session switch failed:', result.error);
          alert(`Failed to switch session: ${result.error}`);
        }
      } catch (error) {
        console.error('Session switch error:', error);
        alert(`Error: ${error.message}`);
      }
    }
    
    // Add click handler to existing session 1 box
    document.addEventListener('DOMContentLoaded', () => {
      const session1Box = document.querySelector('.session-box');
      if (session1Box) {
        session1Box.dataset.sessionId = '1';
        session1Box.addEventListener('click', () => switchToSession(1));
      }
    });
  </script>
</body>

</html>