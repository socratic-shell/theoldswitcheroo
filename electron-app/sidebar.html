<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0;
      padding: 0;
      width: 75px;
      height: 100vh;
      background: #2d2d30;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      font-family: system-ui;
    }

    .portals-container {
      flex: 1;
      padding: 30px 10px 10px 10px;
      /* Top padding for traffic light buttons */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .portal-box {
      width: 55px;
      height: 40px;
      background: #007acc;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
    }

    .portal-box.active {
      background: #40a6ff;
    }

    .bottom-toolbar {
      padding: 10px;
      border-top: 1px solid #3e3e42;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toolbar-button {
      width: 55px;
      height: 40px;
      background: #3c3c3c;
      border: none;
      border-radius: 4px;
      color: #cccccc;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .toolbar-button:hover {
      background: #464647;
    }

    .add-button {
      background: #007acc;
    }

    .add-button:hover {
      background: #40a6ff;
    }

    /* Custom scrollbar */
    .portals-container::-webkit-scrollbar {
      width: 4px;
    }

    .portals-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .portals-container::-webkit-scrollbar-thumb {
      background: #464647;
      border-radius: 2px;
    }

    /* Context menu */
    .context-menu {
      position: fixed;
      background: #3c3c3c;
      border: 1px solid #464647;
      border-radius: 4px;
      padding: 4px 0;
      z-index: 1000;
      display: none;
      min-width: 55px;
      width: 55px;
    }

    .context-menu-item {
      padding: 6px 8px;
      color: #cccccc;
      cursor: pointer;
      font-size: 11px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .context-menu-item:hover {
      background: #464647;
    }

    .context-menu-item.danger {
      color: #f48771;
    }

    .context-menu-item.danger:hover {
      background: #5a2d2d;
    }
  </style>
</head>

<body>
  <div class="portals-container" id="portals-container">
    <!-- portals will be populated dynamically -->
  </div>

  <div class="bottom-toolbar">
    <button class="toolbar-button" id="settings-button">âš™</button>
    <button class="toolbar-button add-button" id="add-button">+</button>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // Handle portal updates from main process
    ipcRenderer.on('update-portals', (event, data) => {
      updatePortalsUI(data.portalData, data.activePortalUuid);
    });

    // Update the portals UI
    function updatePortalsUI(portalData, activePortalUuid) {
      const container = document.getElementById('portals-container');
      container.innerHTML = '';

      portalData.forEach(portalDatum => {
        const portalBox = document.createElement('div');
        portalBox.className = `portal-box ${portalDatum.active ? 'active' : ''}`;
        portalBox.textContent = portalDatum.name;
        portalBox.dataset.portalUuid = portalDatum.uuid;

        // Add click handler for portal switching
        portalBox.addEventListener('click', () => switchToPortal(portalDatum.uuid));

        // Add right-click handler for meta-view
        portalBox.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          toggleView(portalDatum.uuid);
          switchToPortal(portalDatum.uuid);
        });

        container.appendChild(portalBox);
      });
    }

    // Toggle between regular and meta view for portal
    async function toggleView(portalUuid) {
      try {
        const result = await ipcRenderer.invoke('toggle-view', portalUuid);
        if (!result.success) {
          alert(`Failed to toggle view: ${result.error}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Handle + button clicks
    document.getElementById('add-button').addEventListener('click', async () => {
      console.log('+ button clicked in sidebar');

      // Disable button during creation
      const addButton = document.getElementById('add-button');
      addButton.disabled = true;
      addButton.textContent = '...';

      try {
        const result = await ipcRenderer.invoke('create-portal');
        console.log('IPC result:', result);

        if (result.success) {
          console.log(`Added portal with uuid=${result.uuid} and name=${result.name}`);
        } else {
          console.error('portal creation failed:', result.error);
          alert(`Failed to create portal: ${result.error}`);
        }
      } catch (error) {
        console.error('IPC error:', error);
        alert(`Error: ${error.message}`);
      } finally {
        // Re-enable button
        addButton.disabled = false;
        addButton.textContent = '+';
      }
    });

    // Function to switch portals
    async function switchToPortal(portalUuid) {
      console.log(`Switching to portal ${portalUuid}`);

      try {
        const result = await ipcRenderer.invoke('switch-portal', portalUuid);

        if (result.success) {
          // Update UI to show active portal
          document.querySelectorAll('.portal-box').forEach(box => {
            box.classList.remove('active');
          });

          const activeBox = document.querySelector(`[data-portal-id="${portalUuid}"]`);
          if (activeBox) {
            activeBox.classList.add('active');
          }

          console.log(`Switched to portal ${portalUuid}`);
        } else {
          console.error('portal switch failed:', result.error);
          alert(`Failed to switch portal: ${result.error}`);
        }
      } catch (error) {
        console.error('portal switch error:', error);
        alert(`Error: ${error.message}`);
      }
    }
  </script>
</body>

</html>