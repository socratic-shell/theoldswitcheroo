<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100vh;
      background: #2d2d30;
      overflow: hidden;
      display: flex;
      flex-direction: row;
      font-family: system-ui;
    }

    .sidebar-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      transition: opacity 0.2s ease;
    }

    .sidebar-content.collapsed {
      display: none;
    }

    .draggable-bar {
      width: 20px;
      height: 100vh;
      background: #007acc;
      cursor: ew-resize; /* Change to resize cursor */
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-app-region: no-drag; /* No window dragging */
      position: relative;
      flex-shrink: 0;
      user-select: none; /* Prevent text selection */
      -webkit-user-select: none;
    }

    .draggable-bar:hover {
      background: #40a6ff;
    }

    .draggable-bar::before {
      content: "⋮";
      color: white;
      font-size: 16px;
      font-weight: bold;
      transform: rotate(90deg);
    }

    .draggable-bar.collapsed::before {
      content: "▶";
      transform: none;
      font-size: 12px;
    }

    /* Window drag area - add this to the top of sidebar content */
    .window-drag-area {
      height: 30px;
      width: 100%;
      -webkit-app-region: drag;
      background: transparent;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 500;
    }

    .portals-container {
      flex: 1;
      padding: 30px 10px 10px 10px;
      /* Top padding for traffic light buttons */
      overflow-y: auto;
      overflow-x: hidden; /* Prevent horizontal overflow */
      display: flex;
      flex-direction: column;
      gap: 8px;
      -webkit-app-region: no-drag; /* Allow interaction with portal boxes */
    }

    .portal-box {
      width: calc(100% - 20px); /* Account for container padding */
      min-height: 60px;
      background: #007acc;
      border-radius: 6px;
      padding: 12px;
      color: white;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .portal-box.active {
      background: #40a6ff;
    }

    .portal-name {
      font-weight: bold;
      font-size: 14px;
      line-height: 1.2;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
    }

    .portal-bullets {
      font-size: 11px;
      opacity: 0.9;
      line-height: 1.3;
    }

    .portal-bullet {
      display: block;
      margin-bottom: 2px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .portal-bullet:before {
      content: "• ";
      margin-right: 4px;
    }

    .bottom-toolbar {
      padding: 10px;
      border-top: 1px solid #3e3e42;
      display: flex;
      flex-direction: column;
      gap: 8px;
      -webkit-app-region: no-drag; /* Allow interaction with buttons */
    }

    .toolbar-button {
      width: calc(100% - 20px);
      height: 40px;
      background: #3c3c3c;
      border: none;
      border-radius: 4px;
      color: #cccccc;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      margin: 0 10px;
      box-sizing: border-box;
    }

    .toolbar-button:hover {
      background: #464647;
    }

    .add-button {
      background: #007acc;
    }

    .add-button:hover {
      background: #40a6ff;
    }

    /* Custom scrollbar */
    .portals-container::-webkit-scrollbar {
      width: 6px;
    }

    .portals-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .portals-container::-webkit-scrollbar-thumb {
      background: #464647;
      border-radius: 3px;
    }

    /* Context menu */
    .context-menu {
      position: fixed;
      background: #3c3c3c;
      border: 1px solid #464647;
      border-radius: 4px;
      padding: 4px 0;
      z-index: 1000;
      display: none;
      min-width: 120px;
    }

    .context-menu-item {
      padding: 8px 12px;
      color: #cccccc;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }

    .context-menu-item:hover {
      background: #464647;
    }

    .context-menu-item.danger {
      color: #f48771;
    }

    .context-menu-item.danger:hover {
      background: #5a2d2d;
    }

    /* Resize handle */
    .resize-handle {
      position: absolute;
      right: 0; /* Position it on the very right edge of sidebar content */
      top: 0;
      width: 8px; /* Make it wider and easier to grab */
      height: 100%;
      background: transparent;
      cursor: ew-resize;
      -webkit-app-region: no-drag;
      z-index: 1000;
    }

    .resize-handle:hover {
      background: rgba(0, 122, 204, 0.3); /* Semi-transparent blue on hover */
    }

    /* Collapsed state styles */
    .collapsed-sidebar {
      width: 20px;
      height: 100vh;
      background: #3e3e42;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
      gap: 8px;
    }

    .collapsed-portal {
      width: 12px;
      height: 12px;
      background: #007acc;
      border-radius: 2px;
      cursor: pointer;
    }

    .collapsed-portal.active {
      background: #40a6ff;
    }
  </style>
</head>

<body>
  <div class="sidebar-content" id="sidebar-content">
    <div class="window-drag-area"></div>
    <div class="resize-handle" id="resize-handle"></div>
    
    <div class="portals-container" id="portals-container">
      <!-- portals will be populated dynamically -->
    </div>

    <div class="bottom-toolbar">
      <button class="toolbar-button" id="settings-button">⚙ Settings</button>
      <button class="toolbar-button add-button" id="add-button">+ New Portal</button>
    </div>
  </div>

  <div class="draggable-bar" id="draggable-bar"></div>

  <script>
    const { ipcRenderer } = require('electron');

    let isCollapsed = false;
    let currentPortalData = [];

    // Handle portal updates from main process
    ipcRenderer.on('update-portals', (event, data) => {
      currentPortalData = data.portalData;
      updatePortalsUI(data.portalData, data.activePortalUuid);
    });

    // Blue bar resize and collapse functionality
    let isResizingBlueBar = false;
    let resizeStartX = 0;
    
    document.getElementById('draggable-bar').addEventListener('mousedown', (e) => {
      resizeStartX = e.clientX;
      isResizingBlueBar = true;
      document.addEventListener('mousemove', handleBlueBarResize);
      document.addEventListener('mouseup', stopBlueBarResize);
      e.preventDefault();
    });

    function handleBlueBarResize(e) {
      if (!isResizingBlueBar) return;
      
      const deltaX = e.clientX - resizeStartX;
      
      // If moved more than 5px, it's a resize operation
      if (Math.abs(deltaX) > 5) {
        const currentWidth = parseInt(document.body.style.width) || 250;
        const newWidth = currentWidth + deltaX;
        
        if (newWidth >= 250 && newWidth <= 500) {
          ipcRenderer.invoke('resize-sidebar', newWidth);
          resizeStartX = e.clientX; // Update start position for smooth dragging
        }
      }
    }

    function stopBlueBarResize(e) {
      if (isResizingBlueBar) {
        const deltaX = e.clientX - resizeStartX;
        
        // If moved less than 5px, treat it as a click (collapse/expand)
        if (Math.abs(deltaX) <= 5) {
          isCollapsed = !isCollapsed;
          toggleSidebar();
        }
      }
      
      isResizingBlueBar = false;
      document.removeEventListener('mousemove', handleBlueBarResize);
      document.removeEventListener('mouseup', stopBlueBarResize);
    }

    function toggleSidebar() {
      const sidebarContent = document.getElementById('sidebar-content');
      const draggableBar = document.getElementById('draggable-bar');
      
      // Remove any existing collapsed sidebar first
      const existingCollapsed = document.getElementById('collapsed-sidebar');
      if (existingCollapsed) {
        existingCollapsed.remove();
      }
      
      if (isCollapsed) {
        sidebarContent.style.display = 'none';
        draggableBar.classList.add('collapsed');
        ipcRenderer.invoke('resize-sidebar', 20);
        showCollapsedPortals();
      } else {
        sidebarContent.style.display = 'flex';
        draggableBar.classList.remove('collapsed');
        ipcRenderer.invoke('resize-sidebar', 250);
      }
    }

    function showCollapsedPortals() {
      // Create collapsed view
      const collapsedSidebar = document.createElement('div');
      collapsedSidebar.className = 'collapsed-sidebar';
      collapsedSidebar.id = 'collapsed-sidebar';
      
      currentPortalData.forEach(portalDatum => {
        const collapsedPortal = document.createElement('div');
        collapsedPortal.className = `collapsed-portal ${portalDatum.active ? 'active' : ''}`;
        collapsedPortal.title = portalDatum.name;
        collapsedPortal.addEventListener('click', () => switchToPortal(portalDatum.uuid));
        collapsedSidebar.appendChild(collapsedPortal);
      });
      
      // Insert before the draggable bar
      document.body.insertBefore(collapsedSidebar, document.getElementById('draggable-bar'));
    }

    // Add keyboard shortcut for developer tools
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'I') {
        ipcRenderer.invoke('toggle-devtools');
      }
    });

    // Sidebar resize functionality
    let isResizing = false;
    const resizeHandle = document.getElementById('resize-handle');
    
    resizeHandle.addEventListener('mousedown', (e) => {
      if (isCollapsed) return;
      isResizing = true;
      document.addEventListener('mousemove', handleResize);
      document.addEventListener('mouseup', stopResize);
      e.preventDefault();
    });

    function handleResize(e) {
      if (!isResizing || isCollapsed) return;
      
      const newWidth = e.clientX;
      if (newWidth >= 250 && newWidth <= 500) { // Min 250px, max 500px
        ipcRenderer.invoke('resize-sidebar', newWidth);
      }
    }

    function stopResize() {
      isResizing = false;
      document.removeEventListener('mousemove', handleResize);
      document.removeEventListener('mouseup', stopResize);
    }

    // Update the portals UI
    function updatePortalsUI(portalData, activePortalUuid) {
      if (isCollapsed) {
        // Remove old collapsed sidebar if it exists
        const oldCollapsed = document.getElementById('collapsed-sidebar');
        if (oldCollapsed) {
          oldCollapsed.remove();
        }
        showCollapsedPortals();
        return;
      }

      const container = document.getElementById('portals-container');
      container.innerHTML = '';

      portalData.forEach(portalDatum => {
        const portalBox = document.createElement('div');
        portalBox.className = `portal-box ${portalDatum.active ? 'active' : ''}`;
        portalBox.dataset.portalUuid = portalDatum.uuid;

        // Create portal name element
        const nameElement = document.createElement('div');
        nameElement.className = 'portal-name';
        nameElement.textContent = portalDatum.name;

        // Create bullets container
        const bulletsElement = document.createElement('div');
        bulletsElement.className = 'portal-bullets';
        
        // Add some sample bullets (will be replaced with real data later)
        const bullets = [
          'VSCode server running',
          'Extensions loaded',
          `Port ${portalDatum.port || 'pending'}`
        ];
        
        bullets.forEach(bullet => {
          const bulletElement = document.createElement('span');
          bulletElement.className = 'portal-bullet';
          bulletElement.textContent = bullet;
          bulletsElement.appendChild(bulletElement);
        });

        portalBox.appendChild(nameElement);
        portalBox.appendChild(bulletsElement);

        // Add click handler for portal switching
        portalBox.addEventListener('click', () => switchToPortal(portalDatum.uuid));

        // Add right-click handler for meta-view
        portalBox.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          toggleView(portalDatum.uuid);
          switchToPortal(portalDatum.uuid);
        });

        container.appendChild(portalBox);
      });
    }

    // Toggle between regular and meta view for portal
    async function toggleView(portalUuid) {
      try {
        const result = await ipcRenderer.invoke('toggle-view', portalUuid);
        if (!result.success) {
          alert(`Failed to toggle view: ${result.error}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Handle + button clicks
    document.getElementById('add-button').addEventListener('click', async () => {
      console.log('+ button clicked in sidebar');

      // Disable button during creation
      const addButton = document.getElementById('add-button');
      addButton.disabled = true;
      addButton.textContent = '⏳ Creating...';

      try {
        const result = await ipcRenderer.invoke('create-portal');
        console.log('IPC result:', result);

        if (result.success) {
          console.log(`Added portal with uuid=${result.uuid} and name=${result.name}`);
        } else {
          console.error('portal creation failed:', result.error);
          alert(`Failed to create portal: ${result.error}`);
        }
      } catch (error) {
        console.error('IPC error:', error);
        alert(`Error: ${error.message}`);
      } finally {
        // Re-enable button
        addButton.disabled = false;
        addButton.textContent = '+ New Portal';
      }
    }); 

    // Function to switch portals
    async function switchToPortal(portalUuid) {
      console.log(`Switching to portal ${portalUuid}`);

      try {
        const result = await ipcRenderer.invoke('switch-portal', portalUuid);

        if (result.success) {
          // Update UI to show active portal
          document.querySelectorAll('.portal-box').forEach(box => {
            box.classList.remove('active');
          });
          document.querySelectorAll('.collapsed-portal').forEach(box => {
            box.classList.remove('active');
          });

          const activeBox = document.querySelector(`[data-portal-uuid="${portalUuid}"]`);
          if (activeBox) {
            activeBox.classList.add('active');
          }

          console.log(`Switched to portal ${portalUuid}`);
        } else {
          console.error('portal switch failed:', result.error);
          alert(`Failed to switch portal: ${result.error}`);
        }
      } catch (error) {
        console.error('portal switch error:', error);
        alert(`Error: ${error.message}`);
      }
    }
  </script>
</body>

</html>